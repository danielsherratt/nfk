<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NFK Counter</title>

<style>
:root{
  --bg1:#f6f7ff;
  --bg2:#f3fbff;
  --panel:#ffffff;
  --text:#0f172a;
  --muted:#475569;
  --line:rgba(15,23,42,.12);
  --shadow:0 18px 45px rgba(2,6,23,.10);
  --shadow2:0 10px 25px rgba(2,6,23,.08);
  --radius:20px;

  --a1:#7c3aed;
  --a2:#06b6d4;
  --a3:#f97316;
  --a4:#22c55e;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(1200px 700px at 10% -10%, rgba(124,58,237,.16), transparent 55%),
    radial-gradient(1000px 650px at 90% 0%, rgba(6,182,212,.14), transparent 55%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}

header{
  max-width:1120px;
  margin:0 auto;
  padding:18px 16px 12px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
}

.brand{
  display:flex;
  gap:12px;
  align-items:center;
}

.logo{
  width:44px;height:44px;
  border-radius:14px;
  background:conic-gradient(from 180deg,var(--a1),var(--a2),var(--a3),var(--a4),var(--a1));
  box-shadow:var(--shadow2);
}

h1{margin:0;font-size:16px}

.sub{font-size:12px;color:var(--muted);margin-top:4px}

.headerActions{
  display:flex;
  gap:10px;
  align-items:center;
}

.pill{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.75);
  box-shadow:var(--shadow2);
  font-size:12px;
  color:var(--muted);
}

.dlbtn{
  padding:10px 14px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.9);
  box-shadow:var(--shadow2);
  font-size:12px;
  font-weight:800;
  text-decoration:none;
  color:var(--text);
}
.dlbtn:hover{transform:translateY(-1px)}

.wrap{max-width:1120px;margin:0 auto;padding:0 16px 28px}

.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:14px;
}
@media(min-width:980px){
  .grid{grid-template-columns:1.3fr .7fr}
}

.card{
  background:rgba(255,255,255,.82);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

.cardInner{padding:14px}

.controls{display:flex;gap:10px;flex-wrap:wrap}

select,input{
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:#fff;
}

.hide{display:none}

.kpis{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  padding:14px;
}

.kpi{
  border:1px solid var(--line);
  border-radius:18px;
  padding:12px;
  background:#fff;
  box-shadow:var(--shadow2);
}

.kpi .label{font-size:12px;color:var(--muted)}
.kpi .value{
  margin-top:6px;
  font-size:34px;
  font-weight:800;
  background:linear-gradient(90deg,var(--a1),var(--a2),var(--a3));
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
}

.section{padding:12px 14px;border-top:1px solid var(--line)}
.section h2{
  margin:0;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.06em;
  color:var(--muted);
}

canvas{
  width:100%;
  height:220px;
  border-radius:18px;
  border:1px solid var(--line);
  background:#fff;
  box-shadow:var(--shadow2);
}

table{width:100%;border-collapse:collapse}
th,td{
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  font-size:13px;
}
th{font-size:11px;color:var(--muted);text-transform:uppercase}

tbody tr:hover td{background:rgba(124,58,237,.06)}
</style>
</head>

<body>

<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>NFK Counter</h1>
      <div class="sub" id="rangeLabel">—</div>
    </div>
  </div>

  <div class="headerActions">
    <a class="dlbtn" href="/NFKCounter.exe" download>Download</a>
    <div class="pill" id="status">—</div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <div class="cardInner">
        <div class="controls">
          <select id="window">
            <option value="15m">15m</option>
            <option value="60m">60m</option>
            <option value="6h">6h</option>
            <option value="24h" selected>24h</option>
            <option value="7d">7d</option>
            <option value="30d">30d</option>
            <option value="custom">Custom</option>
          </select>

          <input id="from" type="datetime-local" class="hide">
          <input id="to" type="datetime-local" class="hide">
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">Total</div>
          <div class="value" id="totalAll">—</div>
        </div>
        <div class="kpi">
          <div class="label">Range</div>
          <div class="value" id="totalRange">—</div>
        </div>
      </div>

      <div class="section"><h2>Over time</h2></div>
      <div class="cardInner"><canvas id="chartTotal"></canvas></div>

      <div class="section"><h2>Top names</h2></div>
      <div class="cardInner"><canvas id="chartNames"></canvas></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="section"><h2>Recent</h2></div>
      <table>
        <thead><tr><th>Time (NZ)</th><th>Name</th></tr></thead>
        <tbody id="recent"><tr><td colspan="2">—</td></tr></tbody>
      </table>

      <div class="section"><h2>All time</h2></div>
      <table>
        <thead><tr><th>Name</th><th>Count</th></tr></thead>
        <tbody id="allTime"><tr><td colspan="2">—</td></tr></tbody>
      </table>
    </div>

  </div>
</div>

<script>
const API_TOKEN="Granite663WalnutBreezeQuiet!";

const $=id=>document.getElementById(id);
const status=$("status");

function nz12(iso){
  return new Intl.DateTimeFormat("en-NZ",{
    timeZone:"Pacific/Auckland",
    hour:"numeric",minute:"2-digit",second:"2-digit",
    day:"2-digit",month:"2-digit",year:"numeric",
    hour12:true
  }).format(new Date(iso));
}

function qs(){
  if(window.value==="custom"){
    if(!from.value||!to.value)return null;
    return `?from=${new Date(from.value).toISOString()}&to=${new Date(to.value).toISOString()}`;
  }
  return `?window=${window.value}`;
}

async function get(url){
  const r=await fetch(url,{headers:{Authorization:`Bearer ${API_TOKEN}`}});
  if(!r.ok)throw r.status;
  return r.json();
}

async function load(){
  const q=qs(); if(!q)return;
  status.textContent="…";
  try{
    const s=await get(`/api/stats${q}`);
    totalAll.textContent=s.all_time_total;
    totalRange.textContent=s.range_total;
    rangeLabel.textContent=nz12(s.range.from_utc)+" → "+nz12(s.range.to_utc);

    recent.innerHTML=s.recent.map(r=>`<tr><td>${nz12(r.created_at_utc)}</td><td>${r.name}</td></tr>`).join("")||"<tr><td colspan=2>—</td></tr>";
    allTime.innerHTML=s.all_time_per_name.map(r=>`<tr><td>${r.name}</td><td>${r.count}</td></tr>`).join("");

    const bucket=(window.value==="7d"||window.value==="30d")?"day":"hour";
    const t=await get(`/api/timeseries${q}&bucket=${bucket}`);
    draw(chartTotal,t.total.map(x=>x.count));
    draw(chartNames,t.total.map(x=>x.count));
    status.textContent="OK";
  }catch{status.textContent="Fail";}
}

function draw(c,data){
  const ctx=c.getContext("2d");
  c.width=c.clientWidth*devicePixelRatio;
  c.height=c.clientHeight*devicePixelRatio;
  ctx.clearRect(0,0,c.width,c.height);
  const max=Math.max(1,...data);
  const p=30,w=c.width-p*2,h=c.height-p*2;
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x=p+i*(w/(data.length-1||1));
    const y=p+h-(v/max*h);
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });
  ctx.strokeStyle="#7c3aed";
  ctx.lineWidth=3;
  ctx.stroke();
}

window.onchange=()=>{
  from.classList.toggle("hide",window.value!=="custom");
  to.classList.toggle("hide",window.value!=="custom");
  if(window.value!=="custom")load();
};
to.onchange=load;

load();
</script>
</body>
</html>
