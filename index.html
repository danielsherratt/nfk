<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFK Counter</title>
  <style>
    :root{
      --bg:#f6f7fb; --panel:#fff; --text:#172033; --muted:#5c667a; --line:rgba(20,30,45,.14);
      --shadow:0 12px 30px rgba(12,18,28,.10);
      --radius:18px;
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    header{ padding:16px; max-width:1100px; margin:0 auto; display:flex; justify-content:space-between; gap:12px; }
    .wrap{ max-width:1100px; margin:0 auto; padding:0 16px 24px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:980px){ .grid{ grid-template-columns:1.2fr .8fr; } }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; }
    h1{ font-size:16px; margin:0; }
    h2{ font-size:14px; margin:0 0 10px; }
    .muted{ color:var(--muted); font-size:12px; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; font-size:12px; color:var(--muted); height:fit-content; }
    select, input{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; }
    button{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer; }
    button:hover{ transform: translateY(-1px); }
    .row{ display:flex; gap:10px; align-items:end; flex-wrap:wrap; }
    .row > *{ flex:1 1 220px; }
    .kpi{ font-size:34px; font-weight:800; letter-spacing:-0.02em; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ text-align:left; padding:10px 8px; border-bottom:1px solid var(--line); font-size:13px; vertical-align:top; }
    th{ font-size:11px; color:var(--muted); font-weight:700; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>NFK Counter</h1>
      <div class="muted" id="rangeLabel">—</div>
    </div>
    <div class="pill" id="statusPill">—</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="row">
          <div>
            <select id="windowSelect">
              <option value="15m">15m</option>
              <option value="60m">60m</option>
              <option value="6h">6h</option>
              <option value="24h" selected>24h</option>
              <option value="7d">7d</option>
              <option value="30d">30d</option>
              <option value="custom">Custom</option>
            </select>
          </div>

          <div>
            <input id="fromInput" type="datetime-local" />
          </div>

          <div>
            <input id="toInput" type="datetime-local" />
          </div>

          <div style="flex:0 0 140px;">
            <button id="loadBtn" style="width:100%;">Load</button>
          </div>
        </div>

        <div style="height:12px;"></div>

        <div class="row">
          <div class="card" style="box-shadow:none; border:1px solid var(--line);">
            <div class="muted">Total</div>
            <div class="kpi" id="allTimeTotal">—</div>
          </div>
          <div class="card" style="box-shadow:none; border:1px solid var(--line);">
            <div class="muted">Range</div>
            <div class="kpi" id="rangeTotal">—</div>
          </div>
        </div>

        <div style="height:14px;"></div>

        <h2>By name</h2>
        <table>
          <thead><tr><th>Name</th><th>Count</th></tr></thead>
          <tbody id="rangePerNameBody">
            <tr><td colspan="2" class="muted">—</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h2>Recent</h2>
        <table>
          <thead><tr><th>NZ time</th><th>Name</th></tr></thead>
          <tbody id="recentBody">
            <tr><td colspan="2" class="muted">—</td></tr>
          </tbody>
        </table>

        <div style="height:14px;"></div>

        <h2>All time</h2>
        <table>
          <thead><tr><th>Name</th><th>Count</th></tr></thead>
          <tbody id="allTimePerNameBody">
            <tr><td colspan="2" class="muted">—</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // Put your token here
  // =========================
  const API_TOKEN = "PASTE_YOUR_API_TOKEN_HERE";
  // =========================

  const statusPill = document.getElementById("statusPill");
  const windowSelect = document.getElementById("windowSelect");
  const fromInput = document.getElementById("fromInput");
  const toInput = document.getElementById("toInput");
  const loadBtn = document.getElementById("loadBtn");

  const allTimeTotal = document.getElementById("allTimeTotal");
  const rangeTotal = document.getElementById("rangeTotal");
  const rangeLabel = document.getElementById("rangeLabel");

  const rangePerNameBody = document.getElementById("rangePerNameBody");
  const allTimePerNameBody = document.getElementById("allTimePerNameBody");
  const recentBody = document.getElementById("recentBody");

  function setStatus(t){ statusPill.textContent = t; }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // NOTE:
  // datetime-local has no timezone. If your PC is set to NZ time, custom works perfectly.
  // Window mode always works.
  function localToIso(v){
    if(!v) return null;
    const d = new Date(v);
    if (isNaN(d.getTime())) return null;
    return d.toISOString();
  }

  async function loadStats(){
    if(!API_TOKEN || API_TOKEN.includes("PASTE_")){
      setStatus("Token");
      return;
    }

    setStatus("…");
    allTimeTotal.textContent = "—";
    rangeTotal.textContent = "—";
    rangeLabel.textContent = "—";

    try{
      let qs = "";
      const win = windowSelect.value;

      if(win === "custom"){
        const fromIso = localToIso(fromInput.value);
        const toIso = localToIso(toInput.value);
        if(!fromIso || !toIso){
          setStatus("Range");
          return;
        }
        qs = `?from=${encodeURIComponent(fromIso)}&to=${encodeURIComponent(toIso)}`;
      } else {
        qs = `?window=${encodeURIComponent(win)}`;
      }

      const res = await fetch(`/api/stats${qs}`, {
        headers: { Authorization: `Bearer ${API_TOKEN}` }
      });

      if(!res.ok){
        setStatus(String(res.status));
        return;
      }

      const data = await res.json();

      allTimeTotal.textContent = String(data.all_time_total ?? 0);
      rangeTotal.textContent = String(data.range_total ?? 0);

      if(data.range?.from_nz && data.range?.to_nz){
        rangeLabel.textContent = `${data.range.from_nz} → ${data.range.to_nz}`;
      }

      const rangeRows = (data.range_per_name || [])
        .map(r => `<tr><td>${escapeHtml(r.name)}</td><td>${r.count}</td></tr>`)
        .join("");
      rangePerNameBody.innerHTML = rangeRows || `<tr><td colspan="2" class="muted">—</td></tr>`;

      const allRows = (data.all_time_per_name || [])
        .map(r => `<tr><td>${escapeHtml(r.name)}</td><td>${r.count}</td></tr>`)
        .join("");
      allTimePerNameBody.innerHTML = allRows || `<tr><td colspan="2" class="muted">—</td></tr>`;

      const recentRows = (data.recent || [])
        .map(r => `<tr><td class="muted">${escapeHtml(r.created_at_nz)}</td><td>${escapeHtml(r.name)}</td></tr>`)
        .join("");
      recentBody.innerHTML = recentRows || `<tr><td colspan="2" class="muted">—</td></tr>`;

      setStatus("OK");
    } catch {
      setStatus("Fail");
    }
  }

  function updateCustom(){
    const isCustom = windowSelect.value === "custom";
    fromInput.disabled = !isCustom;
    toInput.disabled = !isCustom;
    fromInput.style.opacity = isCustom ? "1" : ".5";
    toInput.style.opacity = isCustom ? "1" : ".5";
  }

  windowSelect.addEventListener("change", updateCustom);
  loadBtn.addEventListener("click", loadStats);
  updateCustom();
  loadStats();
})();
</script>
</body>
</html>
